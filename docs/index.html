<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Uma Builder — Card Picker</title>
<style>
:root {
  --card-w: 118px;
  --gap: 10px;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  font-family: Arial, Helvetica, sans-serif;
  background: #fff;
  color: #111;
}

/* ---------- CONTAINER & SIDEBAR ---------- */
.container {
  display: flex;
  width: 100%;
  height: 100vh;
  overflow: hidden;
}

.sidebar {
  flex-shrink: 0;
  width: 200px;
  padding: 24px 12px;
  box-sizing: border-box;
  background: #f9f9f9;
  overflow-y: auto;
}

/* ---------- SIDEBAR IMPROVEMENTS ---------- */
.sidebar .filter-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 16px; /* consistent gap */
}

.sidebar .filter-group label {
  margin-bottom: 4px; /* one line above select */
  font-weight: 600;
  font-size: 13px;
}

.sidebar select, .sidebar .skill-search {
  width: 100%;
  max-width: 180px; /* consistent width similar to skill-search */
  padding: 6px 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

/* ---------- SKILLS FONT SIZE ---------- */
.slot .skill, .card .skill {
  font-size: 9px; /* revert to previous smaller size */
  padding: 3px 6px;
}

/* ---------- HIGHLIGHT STYLE ---------- */
.skill.highlighted {
  outline: 2px solid #ff9900;
  outline-offset: -2px;
}


/* Hide scrollbar but allow scrolling */
.sidebar::-webkit-scrollbar { width: 0; background: transparent; }
.sidebar { -ms-overflow-style: none; scrollbar-width: none; }

/* ---------- MAIN CONTENT ---------- */
.main-content {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  align-items: center;      /* horizontally center */
  justify-content: flex-start; /* push from top, adjust if needed */
  overflow-y: auto;
  padding: 24px;
  box-sizing: border-box;
}

/* Wrapper to center slots + cards */
.content-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  width: 100%;
  max-width: calc((var(--card-w) + var(--gap)) * 6); /* constrain max width */
  margin: 0 auto; /* center horizontally */
}

/* SLOTS GRID */
.slots {
  display: grid;
  grid-template-columns: repeat(6, var(--card-w));
  gap: var(--gap);
  margin-bottom: 24px;
  width: 100%;
}

/* CARD GRID */
.cards {
  display: grid;
  grid-template-columns: repeat(6, var(--card-w));
  gap: var(--gap);
}

/* SLOT & CARD BLOCK */
.slot, .card {
  border: 1px solid #ddd;
  padding: 8px;
  box-sizing: border-box;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  width: var(--card-w);
  min-height: 490px;
  position: relative;
}

.slot:not(.has-card) {
  border: 2px dashed #ccc;
  background: #fafafa;
}

.slot .placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ccc;
  font-size: 12px;
}

.slot .name, .card .name {
  margin: 8px 0 6px 0;
  font-weight: 700;
  text-align: center;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.slot .skills, .card .skills,
.slot .skills-group, .card .skills-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
  align-items: center;
}

.slot .skill, .card .skill {
  width: 100%;
  background: #eef2ff;
  border-radius: 6px;
  padding: 4px 6px;
  font-size: 10px;
  word-break: break-word;
  white-space: normal;
  text-align: center;
}

.slot img, .card img {
  max-width: 100%;
  max-height: 100px;
  object-fit: contain;
}

/* TYPE ICON */
.slot .type-icon, .card .type-icon {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  border: 1px solid #ccc;
  background: #fff;
  border-radius: 4px;
  overflow: hidden;
  text-align: center;
  font-size: 10px;
  line-height: 18px;
  font-weight: bold;
}

.slot .type-icon img, .card .type-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* Hide duplicates */
.card.disabled {
  opacity: 0.45;
}

/* CLEAR BUTTON */
.clear-all {
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  border-radius: 6px;
  background: #444;
  color: #fff;
}

/* CARD SECTIONS */
.card-sections {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  gap: 20px;
}
</style>

</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="filter-group">
        <label for="racecourse">Racecourse</label>
        <select id="racecourse">
          <option value="">-- Select --</option>
          <option value="Sapporo">Sapporo</option>
          <option value="Hakodate">Hakodate</option>
          <option value="Niigata">Niigata</option>
          <option value="Fukushima">Fukushima</option>
          <option value="Nakayama">Nakayama</option>
          <option value="Tokyo">Tokyo</option>
          <option value="Chukyo">Chukyo</option>
          <option value="Kyoto">Kyoto</option>
          <option value="Hanshin">Hanshin</option>
          <option value="Kokura">Kokura</option>
          <option value="Oi">Oi</option>
          <option value="Kawasaki">Kawasaki</option>
          <option value="Funabashi">Funabashi</option>
          <option value="Morioka">Morioka</option>
          <option value="Longchamp">Longchamp</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="length">Length</label>
        <select id="length">
          <option value="">-- Select --</option>
          <option value="1000">1000m</option>
          <option value="1150">1150m</option>
          <option value="1200">1200m</option>
          <option value="1300">1300m</option>
          <option value="1400">1400m</option>
          <option value="1500">1500m</option>
          <option value="1600">1600m</option>
          <option value="1700">1700m</option>
          <option value="1800">1800m</option>
          <option value="1900">1900m</option>
          <option value="2000">2000m</option>
          <option value="2100">2100m</option>
          <option value="2200">2200m</option>
          <option value="2300">2300m</option>
          <option value="2400">2400m</option>
          <option value="2500">2500m</option>
          <option value="2600">2600m</option>
          <option value="3000">3000m</option>
          <option value="3200">3200m</option>
          <option value="3400">3400m</option>
          <option value="3600">3600m</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="direction">Direction</label>
        <select id="direction">
          <option value="">-- Select --</option>
          <option value="Clockwise">Clockwise</option>
          <option value="Counterclockwise">Counterclockwise</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="track">Track Conditions</label>
        <select id="track">
          <option value="">-- Select --</option>
          <option value="Firm">Firm</option>
          <option value="Good">Good</option>
          <option value="Soft">Soft</option>
          <option value="Heavy">Heavy</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="season">Season</label>
        <select id="season">
          <option value="">-- Select --</option>
          <option value="Spring">Spring</option>
          <option value="Summer">Summer</option>
          <option value="Fall">Fall</option>
          <option value="Winter">Winter</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="weather">Weather</label>
        <select id="weather">
          <option value="">-- Select --</option>
          <option value="Sunny">Sunny</option>
          <option value="Cloudy">Cloudy</option>
          <option value="Rainy">Rainy</option>
          <option value="Snowy">Snowy</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="strategy">Strategy</label>
        <select id="strategy">
          <option value="">-- Select --</option>
          <option value="Front Runner">Front Runner</option>
          <option value="Pace Chaser">Pace Chaser</option>
          <option value="Late Surger">Late Surger</option>
          <option value="End Closer">End Closer</option>
        </select>
      </div>

      <!-- Clear Filters Button -->
      <button id="clearFiltersBtn" class="clear-all mb-2">Clear Filters</button>

      <!-- Skill Search Bars -->
      <div id="skillSearchGroup">
        <label for="skillSearch1" class="font-bold mb-1">Skill Search</label>
        <input type="text" id="skillSearch1" class="skill-search" placeholder="Search skill 1">
        <input type="text" id="skillSearch2" class="skill-search" placeholder="Search skill 2">
        <input type="text" id="skillSearch3" class="skill-search" placeholder="Search skill 3">
        <input type="text" id="skillSearch4" class="skill-search" placeholder="Search skill 4">
        <input type="text" id="skillSearch5" class="skill-search" placeholder="Search skill 5">
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="content-wrapper">
        <div class="slots-header">
          <button class="clear-all" id="clearAllBtn">Clear All</button>
        </div>

        <div class="slots" id="slots">
          <div class="slot" data-slot="0"><div class="placeholder">Empty</div></div>
          <div class="slot" data-slot="1"><div class="placeholder">Empty</div></div>
          <div class="slot" data-slot="2"><div class="placeholder">Empty</div></div>
          <div class="slot" data-slot="3"><div class="placeholder">Empty</div></div>
          <div class="slot" data-slot="4"><div class="placeholder">Empty</div></div>
          <div class="slot" data-slot="5"><div class="placeholder">Empty</div></div>
        </div>

        <div id="cardSections" class="card-sections"></div>
      </div>
    </div>
  </div>
</body>


<script>
/* ---------------- CONFIG ---------------- */
const JSON_FILE = "transformed_supports.json";
const HIDE = { char_id: false, url_name: true };
const SLOT_KEY = 'saved_slots';
const FILTER_KEYS = ['racecourse','length','direction','track','season','weather','strategy'];
const SKILL_SEARCH_KEYS = ['skillSearch1','skillSearch2','skillSearch3','skillSearch4','skillSearch5'];
const CARDS_PER_PAGE = 6;

let cardsData = [];
let sectionPages = new Map();
let slotListeners = new Map();
let selectedCardIds = new Set();

const cardSections = document.getElementById('cardSections');
const slots = Array.from(document.querySelectorAll('.slot'));
const clearAllBtn = document.getElementById('clearAllBtn');
const clearFiltersBtn = document.getElementById('clearFiltersBtn');

/* ---------------- UTILS ---------------- */
const normalize = s => String(s||'').replace(/[◎○]/g,'').trim().toLowerCase();
const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1).toLowerCase();
const isStandardDistance = d => d % 400 === 0;
const getLengthCategory = d => d<=1400?'Sprint':d<=1800?'Mile':d<=2400?'Medium':'Long';
const escapeHtml = s => String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));

/* ---------------- TYPE ICON MAP ---------------- */
const typeMap = { "speed":"00","stamina":"01","power":"02","guts":"03","intelligence":"04","support":"05","group":"06" };

/* ---------------- FETCH JSON ---------------- */
fetch(JSON_FILE)
  .then(r => r.ok ? r.json() : Promise.reject(`Failed: ${r.status}`))
  .then(data => {
    cardsData = data.map(c=>({
      ...c,
      type: (c.type||'').toLowerCase(),
      hint_skills: c.hint_skills||[],
      event_skills: c.event_skills||[]
    }));
    setupFilterPersistence();
    setupSkillPersistence();
    loadSlotsFromLocalStorage();
    renderSections();
  })
  .catch(err => {
    console.error(err);
    cardSections.innerHTML='<div style="opacity:0.7;padding:12px;">Error loading data.</div>';
  });

/* ---------------- SLOT HANDLING ---------------- */
function createCardElement(card){
  const el = document.createElement('div');
  el.className = 'card';
  el.dataset.id = card.char_id;
  el.dataset.supportId = card.support_id;

  const imgSrc = `https://gametora.com/images/umamusume/supports/support_card_s_${card.support_id}.png`;
  const typeImg = `https://gametora.com/images/umamusume/icons/utx_ico_obtain_${typeMap[card.type]||"xx"}.png`;

  let skillsHTML = '';
  if(card.hint_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Support Hints</div>${card.hint_skills.map(s=>`<div class="skill">${escapeHtml(s)}</div>`).join('')}</div>`;
  if(card.event_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Event Skills</div>${card.event_skills.map(s=>`<div class="skill">${escapeHtml(s)}</div>`).join('')}</div>`;

  let nameHtml = `<div class="name">${escapeHtml(card.char_name)}</div>`;
  if(!HIDE.char_id) nameHtml += `<div style="font-size:10px;opacity:0.6;">ID: ${card.char_id}</div>`;
  if(!HIDE.url_name && card.url_name) nameHtml += `<div style="font-size:10px;opacity:0.6;">${escapeHtml(card.url_name)}</div>`;

  el.innerHTML = `<div class="type-icon"><img src="${typeImg}"></div><img src="${imgSrc}">${nameHtml}<div class="skills">${skillsHTML}</div>`;

  el.addEventListener('click', ()=>{
    const slot = slots.find(s => Number(s.dataset.cardId) === card.char_id);
    slot ? removeFromSlot(slot, card) : addToSlot(card);
  });

  return el;
}

function addToSlot(card, targetSlot=null, save=true){
  const freeSlot = targetSlot || slots.find(s => !s.dataset.cardId);
  if(!freeSlot) return;

  if(slotListeners.has(freeSlot)) {
    freeSlot.removeEventListener('click', slotListeners.get(freeSlot));
    slotListeners.delete(freeSlot);
  }

  const skillsHTML = [...card.hint_skills, ...card.event_skills].map(s=>`<div class="skill">${escapeHtml(s)}</div>`).join('');
  freeSlot.dataset.cardId = card.char_id;
  freeSlot.dataset.supportId = card.support_id;
  freeSlot.classList.add('has-card');
  freeSlot.innerHTML = `<div class="type-icon"><img src="https://gametora.com/images/umamusume/icons/utx_ico_obtain_${typeMap[card.type]||"xx"}.png"></div><img src="https://gametora.com/images/umamusume/supports/support_card_s_${card.support_id}.png"><div class="name">${escapeHtml(card.char_name)}</div><div class="skills">${skillsHTML}</div>`;

  const handler = () => removeFromSlot(freeSlot, card);
  freeSlot.addEventListener('click', handler);
  slotListeners.set(freeSlot, handler);

  selectedCardIds.add(card.char_id);
  if(save) saveSlotsToLocalStorage();
  renderSections();
}

function removeFromSlot(slotEl, card){
  if(slotListeners.has(slotEl)){
    slotEl.removeEventListener('click', slotListeners.get(slotEl));
    slotListeners.delete(slotEl);
  }
  slotEl.classList.remove('has-card');
  delete slotEl.dataset.cardId;
  slotEl.innerHTML='<div class="placeholder">Empty</div>';
  selectedCardIds.delete(Number(card.char_id));
  saveSlotsToLocalStorage();
  renderSections();
}

function saveSlotsToLocalStorage(){
  const data = slots.map(s=>s.dataset.supportId||null);
  localStorage.setItem(SLOT_KEY, JSON.stringify(data));
}

function loadSlotsFromLocalStorage(){
  const saved = JSON.parse(localStorage.getItem(SLOT_KEY)||'[]');
  saved.forEach((supportId, idx)=>{
    if(supportId){
      const card = cardsData.find(c=>String(c.support_id)===String(supportId));
      if(card) addToSlot(card, slots[idx], false);
    }
  });
}

/* ---------------- CLEAR BUTTONS ---------------- */
clearAllBtn.addEventListener('click', ()=>{
  selectedCardIds.clear();
  slots.forEach(s=>{
    if(slotListeners.has(s)){
      s.removeEventListener('click', slotListeners.get(s));
      slotListeners.delete(s);
    }
    s.classList.remove('has-card');
    delete s.dataset.cardId;
    s.innerHTML='<div class="placeholder">Empty</div>';
  });
  localStorage.removeItem(SLOT_KEY);
  renderSections();
});

clearFiltersBtn.addEventListener('click', ()=>{
  FILTER_KEYS.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = '';
    localStorage.removeItem('filter_'+id);
  });
  sectionPages.clear();
  renderSections();
});

/* ---------------- FILTER & SKILL PERSISTENCE ---------------- */
function setupFilterPersistence(){
  FILTER_KEYS.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const saved = localStorage.getItem('filter_'+id);
    if(saved) el.value = saved;
    el.addEventListener('change', ()=>{
      localStorage.setItem('filter_'+id, el.value);
      sectionPages.clear();
      renderSections();
    });
  });
}

function setupSkillPersistence(){
  SKILL_SEARCH_KEYS.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const saved = localStorage.getItem('filter_'+id);
    if(saved) el.value = saved;
    el.addEventListener('input', ()=>{
      localStorage.setItem('filter_'+id, el.value);
      sectionPages.clear();
      renderSections();
    });
  });
}

/* ---------------- HIGHLIGHT SKILLS ---------------- */
const filterColors = {
  racecourse:'#ff7792', length:'#ffae77', direction:'#ffff77',
  track:'#77ff92', season:'#77c9ff', weather:'#c977ff', strategy:'#ff77e4'
};

function highlightSkills(filters){
  document.querySelectorAll('.skill').forEach(s=>{
    s.style.background='#eef2ff';
    s.style.color='#000';
  });

  const rules = [];
  if(filters.racecourse) rules.push({color:filterColors.racecourse, terms:[`${filters.racecourse} Racecourse`]});
  if(filters.length){
    const d = parseInt(filters.length);
    const cat = getLengthCategory(d);
    const distType = isStandardDistance(d)?'Standard Distance':'Non-Standard Distance';
    rules.push({color:filterColors.length, terms:[`${cat} Corners`, `${cat} Straightaways`, distType]});
  }
  if(filters.direction) rules.push({color:filterColors.direction, terms:[filters.direction==='Clockwise'?'Right-Handed':'Left-Handed']});
  if(filters.track) rules.push({color:filterColors.track, terms:[filters.track==='Firm'?'Firm Conditions':'Wet Conditions']});
  if(filters.season) rules.push({color:filterColors.season, terms:[`${filters.season} Runner`]});
  if(filters.weather) rules.push({color:filterColors.weather, terms:[`${capitalize(filters.weather)} Days`]});
  if(filters.strategy){
    const s = filters.strategy;
    rules.push({color:filterColors.strategy, terms:[`${s} Corners`, `${s} Straightaways`, `${s} Savvy`]});
  }

  const normalizedRules = rules.map(r=>({color:r.color, terms:r.terms.map(normalize)}));
  document.querySelectorAll('.skill').forEach(skill=>{
    const t = normalize(skill.textContent||'');
    for(const r of normalizedRules){
      if(r.terms.includes(t)){
        skill.style.background=r.color;
        skill.style.color='#000';
        break;
      }
    }
  });
}

/* ---------------- FILTERING ---------------- */
function buildFilterTerms(filters){
  const terms = [];
  if(filters.racecourse) terms.push(`${filters.racecourse} Racecourse`);
  if(filters.direction) terms.push(filters.direction==='Clockwise'?'Right-Handed':'Left-Handed');
  if(filters.track) terms.push(filters.track==='Firm'?'Firm Conditions':'Wet Conditions');
  if(filters.season) terms.push(`${filters.season} Runner`);
  if(filters.weather) terms.push(`${capitalize(filters.weather)} Days`);
  if(filters.strategy) terms.push(filters.strategy);
  if(filters.length){
    const d = parseInt(filters.length);
    const cat = getLengthCategory(d);
    terms.push(`${cat} Corners`);
    terms.push(`${cat} Straightaways`);
    terms.push(isStandardDistance(d)?'Standard Distance':'Non-Standard Distance');
  }
  return terms;
}

function getFilteredCards(){
  const filters = FILTER_KEYS.reduce((acc, key)=>{
    const val = document.getElementById(key)?.value||'';
    if(val) acc[key]=val;
    return acc;
  }, {});
  const skillTerms = SKILL_SEARCH_KEYS
    .map(id=>document.getElementById(id)?.value.trim().toLowerCase())
    .filter(Boolean);

  return cardsData.filter(card=>{
    const skills = [...card.hint_skills, ...card.event_skills].map(normalize);

    // dropdown matching
    const dropdownTerms = buildFilterTerms(filters).map(normalize);
    const strictKeys = ['standard distance','non-standard distance'];
    const strictTerms = dropdownTerms.filter(t=>strictKeys.includes(t));
    const looseTerms = dropdownTerms.filter(t=>!strictKeys.includes(t));
    const dropdownMatch = strictTerms.every(t=>skills.includes(t)) &&
                          looseTerms.every(t=>skills.some(s=>s.includes(t)));

    // skill search
    const skillMatch = skillTerms.every(t=>skills.some(s=>s.includes(t)));

    // exclude already selected card
    const notSelected = !selectedCardIds.has(card.char_id) || slots.some(s=>Number(s.dataset.cardId)===card.char_id);

    return dropdownMatch && skillMatch && notSelected;
  });
}

/* ---------------- RENDER SECTIONS ---------------- */
function renderSections(){
  const filteredCards = getFilteredCards();
  const totalPages = Math.ceil(filteredCards.length/CARDS_PER_PAGE) || 1;
  let currentPage = sectionPages.get('all')||1;
  if(currentPage>totalPages) currentPage = totalPages;
  sectionPages.set('all', currentPage);

  const start = (currentPage-1)*CARDS_PER_PAGE;
  const end = start+CARDS_PER_PAGE;

  cardSections.innerHTML = '';
  if(filteredCards.length===0){
    cardSections.innerHTML='<div style="opacity:0.7;padding:12px;">No cards found.</div>';
    return;
  }

  const pageCards = filteredCards.slice(start,end);
  pageCards.forEach(c=>cardSections.appendChild(createCardElement(c)));

  // pagination
  const pag = document.createElement('div');
  pag.className='pagination';
  if(currentPage>1){
    const prev = document.createElement('button');
    prev.textContent='Prev';
    prev.addEventListener('click',()=>{sectionPages.set('all',currentPage-1); renderSections();});
    pag.appendChild(prev);
  }
  if(currentPage<totalPages){
    const next = document.createElement('button');
    next.textContent='Next';
    next.addEventListener('click',()=>{sectionPages.set('all',currentPage+1); renderSections();});
    pag.appendChild(next);
  }
  cardSections.appendChild(pag);

  // highlight filtered skills
  const filters = FILTER_KEYS.reduce((acc,key)=>{acc[key]=document.getElementById(key)?.value||'';return acc;}, {});
  highlightSkills(filters);
}
</script>


</body>
</html>
