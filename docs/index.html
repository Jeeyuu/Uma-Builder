<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Uma Builder â€” Card Picker</title>
<style>
:root {
  --card-w: 118px;
  --gap: 10px;
}

body {
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 0;
  width: 100%;
  background: #fff;
  color: #111;
  display: flex;
  justify-content: center;
}

.container {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  padding: 24px;

  /* ðŸ”½ shrink to fit main-content width */
  width: auto;
  max-width: none;
}


.sidebar {
  flex-shrink: 0;
  width: 200px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.filter-group label {
  font-weight: 700;
  margin-bottom: 6px;
  display: block;
  font-size: 14px;
}

select {
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  width: 100%;
  font-size: 14px;
}

/* ---------------- SHRINK-FIT MAIN CONTENT ---------------- */
.main-content {
  display: inline-flex;   /* shrink-to-fit */
  flex-direction: column;
  align-items: flex-start;
  width: calc((var(--card-w) + var(--gap)) * 6 - var(--gap));
}

/* ---------------- SLOTS ---------------- */
.slots-header {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 8px;
  width: 100%;
}

.clear-all {
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
  border: none;
  border-radius: 6px;
  background: #444;
  color: #fff;
}

.slots {
  display: grid;
  grid-template-columns: repeat(6, var(--card-w));
  gap: var(--gap);
  margin-bottom: 18px;
  width: calc((var(--card-w) + var(--gap)) * 6 - var(--gap));
}

.slot, .card {
  border: 1px solid #ddd;
  padding: 8px;
  box-sizing: border-box;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  width: var(--card-w);
  position: relative;
}

.slot:not(.has-card) {
  border: 2px dashed #ccc;
  background: #fafafa;
}

.slot .placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ccc;
  font-size: 12px;
}

.slot .name, .card .name {
  margin: 8px 0 6px 0;
  font-weight: 700;
  text-align: center;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.slot .skills, .card .skills,
.slot .skills-group, .card .skills-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  width: 100%;
  align-items: center;
}

.slot .skill, .card .skill {
  width: 100%;
  background: #eef2ff;
  border-radius: 6px;
  padding: 4px 6px;
  font-size: 10px;
  word-break: break-word;
  white-space: normal;
  text-align: center;
}

.slot img, .card img {
  max-width: 100%;
  max-height: 100px;
  object-fit: contain;
}

.slot .type-icon, .card .type-icon {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  border: 1px solid #ccc;
  background: #fff;
  border-radius: 4px;
  overflow: hidden;
  text-align: center;
  font-size: 10px;
  line-height: 18px;
  font-weight: bold;
}

.slot .type-icon img, .card .type-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.card.disabled {
  opacity: 0.45;
}

.skills-header {
  font-weight: bold;
  font-size: 10px;
  color: #444;
  margin-bottom: 2px;
  text-align: center;
}

/* ---------------- CARD SECTION ---------------- */
.card-sections,
.card-section {
  width: calc((var(--card-w) + var(--gap)) * 6 - var(--gap));
}

.card-section {
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.card-section h2 {
  margin: 0 0 6px 0;
  font-size: 16px;
}

/* WRAPPER TO ALIGN GRID + ARROWS */
.card-grid-wrapper {
  display: inline-block; /* shrink to fit cards */
  position: relative;
}

/* GRID OF CARDS */
.cards {
  display: grid;
  grid-template-columns: repeat(6, var(--card-w));
  gap: var(--gap);
}

/* ARROWS */
.page-controls {
  position: absolute;
  top: -26px; /* move up near header */
  right: 0;
  display: flex;
  gap: 6px;
  align-items: center;
}

.page-controls button {
  border: none;
  border-radius: 6px;
  background: #444;
  color: #fff;
  padding: 4px 8px;
  opacity: 0.4;
  pointer-events: none;
  height: auto;
}

@media (max-width: 1100px) {
  :root { --card-w: 100px; }
}
</style>

</head>

<body>

<div class="container">
  <div class="sidebar">
    <div class="filter-group">
      <label for="racecourse">Racecourse</label>
      <select id="racecourse"><option value="">-- Select --</option>
        <option>Sapporo</option><option>Hakodate</option><option>Niigata</option><option>Fukushima</option>
        <option>Nakayama</option><option>Tokyo</option><option>Chukyo</option><option>Kyoto</option>
        <option>Hanshin</option><option>Kokura</option><option>Oi</option><option>Kawasaki</option>
        <option>Funabashi</option><option>Morioka</option><option>Longchamp</option>
      </select>
    </div>
    <div class="filter-group"><label for="length">Length</label>
      <select id="length"><option value="">-- Select --</option>
        <option value="1000">1000m</option><option value="1150">1150m</option><option value="1200">1200m</option>
        <option value="1300">1300m</option><option value="1400">1400m</option><option value="1500">1500m</option>
        <option value="1600">1600m</option><option value="1700">1700m</option><option value="1800">1800m</option>
        <option value="1900">1900m</option><option value="2000">2000m</option><option value="2100">2100m</option>
        <option value="2200">2200m</option><option value="2300">2300m</option><option value="2400">2400m</option>
        <option value="2500">2500m</option><option value="2600">2600m</option><option value="3000">3000m</option>
        <option value="3200">3200m</option><option value="3400">3400m</option><option value="3600">3600m</option>
      </select>
    </div>
    <div class="filter-group"><label for="direction">Direction</label>
      <select id="direction"><option value="">-- Select --</option>
        <option>Clockwise</option><option>Counterclockwise</option>
      </select>
    </div>
    <div class="filter-group"><label for="track">Track Conditions</label>
      <select id="track"><option value="">-- Select --</option>
        <option>Firm</option><option>Good</option><option>Soft</option><option>Heavy</option>
      </select>
    </div>
    <div class="filter-group"><label for="season">Season</label>
      <select id="season"><option value="">-- Select --</option>
        <option>Spring</option><option>Summer</option><option>Fall</option><option>Winter</option>
      </select>
    </div>
    <div class="filter-group"><label for="weather">Weather</label>
      <select id="weather"><option value="">-- Select --</option>
        <option>Sunny</option><option>Cloudy</option><option>Rainy</option><option>Snowy</option>
      </select>
    </div>
    <div class="filter-group"><label for="strategy">Strategy</label>
      <select id="strategy"><option value="">-- Select --</option>
        <option>Front Runner</option><option>Pace Chaser</option><option>Late Surger</option><option>End Closer</option>
      </select>
    </div>
    <button id="clearFiltersBtn" class="clear-all" style="margin-top:auto;">Clear Filters</button>
  </div>

  <div class="main-content">
    <div class="slots-header">
      <button class="clear-all" id="clearAllBtn">Clear All</button>
    </div>
    <div class="slots" id="slots">
      <div class="slot" data-slot="0"><div class="placeholder">Empty</div></div>
      <div class="slot" data-slot="1"><div class="placeholder">Empty</div></div>
      <div class="slot" data-slot="2"><div class="placeholder">Empty</div></div>
      <div class="slot" data-slot="3"><div class="placeholder">Empty</div></div>
      <div class="slot" data-slot="4"><div class="placeholder">Empty</div></div>
      <div class="slot" data-slot="5"><div class="placeholder">Empty</div></div>
    </div>
    <div id="cardSections" class="card-sections"></div>
  </div>
</div>

<script>
/* ------------- CONFIG ------------- */
const JSON_FILE = "transformed_supports.json";
const HIDE = { char_id: false, url_name: true };

/* ------------- STATE ------------- */
let cardsData = [];
const cardSections = document.getElementById('cardSections');
const slots = Array.from(document.querySelectorAll('.slot'));
const clearAllBtn = document.getElementById('clearAllBtn');
const clearFiltersBtn = document.getElementById('clearFiltersBtn');
const selectedCardIds = new Set();
const sectionPages = new Map(); // pagination per section
const slotListeners = new Map();
const SLOT_KEY = 'saved_slots';
const FILTER_KEYS = ['racecourse','length','direction','track','season','weather','strategy'];

/* ------------- UTIL ------------- */
function normalizeSkill(s){ return String(s||'').replace(/[â—Žâ—‹]/g,'').trim().toLowerCase(); }
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase(); }
function getLengthCategory(distance){ if(distance<=1400)return'Sprint'; if(distance<=1800)return'Mile'; if(distance<=2400)return'Medium'; return'Long'; }
function isStandardDistance(distance){ return distance%400===0; }
const typeMap = { "speed":"00","stamina":"01","power":"02","guts":"03","intelligence":"04","support":"05","group":"06" };
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ------------- Fetch JSON ------------- */
fetch(JSON_FILE)
  .then(r=>{ if(!r.ok) throw new Error('Failed to fetch JSON: '+r.status); return r.json(); })
  .then(data=>{
    cardsData = data.map(card=>({
      ...card,
      char_id: card.char_id,
      char_name: card.char_name,
      hint_skills: card.hint_skills || [],
      event_skills: card.event_skills || [],
      type: (card.type || '').toLowerCase()
    }));

    setupFilterPersistence();  // restore filters first
    loadSlotsFromLocalStorage(); // restore slots next
    renderSections();
  })
  .catch(err=>{
    console.error('Could not load JSON:', err);
    cardSections.innerHTML='<div style="opacity:0.7;padding:12px;">Error loading data. Check JSON file path and content in console.</div>';
  });

/* ------------- Card creation ------------- */
function createCardElement(card){
  const el = document.createElement('div');
  el.className = 'card';
  el.dataset.id = card.char_id;
  el.dataset.supportId = card.support_id;
  el.dataset.name = card.char_name;

  const imgSrc = `https://gametora.com/images/umamusume/supports/support_card_s_${card.support_id}.png`;
  const typeImg = `https://gametora.com/images/umamusume/icons/utx_ico_obtain_${typeMap[card.type]||"xx"}.png`;

  let skillsHTML = '';
  if(card.hint_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Support Hints</div>${card.hint_skills.map(s=>`<div class="skill">${escapeHtml(s)}</div>`).join('')}</div>`;
  if(card.event_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Event Skills</div>${card.event_skills.map(s=>`<div class="skill">${escapeHtml(s)}</div>`).join('')}</div>`;

  let nameHtml = `<div class="name">${escapeHtml(card.char_name)}</div>`;
  if(!HIDE.char_id) nameHtml += `<div style="font-size:10px;opacity:0.6;">ID: ${card.char_id}</div>`;
  if(!HIDE.url_name && card.url_name) nameHtml += `<div style="font-size:10px;opacity:0.6;">${escapeHtml(card.url_name)}</div>`;

  // Base card content
  el.innerHTML = `
    <div class="type-icon"><img src="${typeImg}" alt="${escapeHtml(card.type)}"></div>
    <img src="${imgSrc}" alt="${escapeHtml(card.char_name)}">
    ${nameHtml}
    <div class="skills">${skillsHTML}</div>
  `;

  // Handle click
  el.addEventListener('click', ()=> {
    const slot = slots.find(s => Number(s.dataset.cardId) === card.char_id);
    if(slot) removeFromSlot(slot, card);
    else addToSlot(card);
  });

  // Duplicate support label at the top
  if(selectedCardIds.has(card.char_id)){
    el.classList.add('disabled');

    const dupLabel = document.createElement('div');
    dupLabel.textContent = 'Duplicate Support';
    dupLabel.style.position = 'absolute';
    dupLabel.style.top = '0';
    dupLabel.style.left = '0';
    dupLabel.style.width = '100%';
    dupLabel.style.background = 'red';
    dupLabel.style.color = 'white';
    dupLabel.style.fontSize = '10px';
    dupLabel.style.fontWeight = 'bold';
    dupLabel.style.textAlign = 'center';
    dupLabel.style.padding = '2px 0';
    dupLabel.style.borderTopLeftRadius = '6px';
    dupLabel.style.borderTopRightRadius = '6px';
    el.appendChild(dupLabel);
  }

  return el;
}

}


/* ------------- Slot handling & persistence ------------- */
function saveSlotsToLocalStorage() {
  // Save support_id for each slot instead of just char_id
  const slotData = slots.map(s => s.dataset.supportId || null);
  localStorage.setItem(SLOT_KEY, JSON.stringify(slotData));
}

function loadSlotsFromLocalStorage() {
  const saved = localStorage.getItem(SLOT_KEY);
  if (!saved) return;
  const slotData = JSON.parse(saved);

  slotData.forEach((supportId, index) => {
    if (supportId) {
      // Find card by support_id (unique)
      const card = cardsData.find(c => String(c.support_id) === String(supportId));
      if (card) addToSlot(card, slots[index], false); // false = don't save again
    }
  });
}

function addToSlot(card, targetSlot = null, save = true){
  const freeSlot = targetSlot || slots.find(s => !s.dataset.cardId);
  if(!freeSlot) return;

  if(slotListeners.has(freeSlot)){
    freeSlot.removeEventListener('click', slotListeners.get(freeSlot));
    slotListeners.delete(freeSlot);
  }

  let skillsHTML = '';
  if(card.hint_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Support Hints</div>${card.hint_skills.map(s=>`<div class="skill">${escapeHtml(s)}</div>`).join('')}</div>`;
  if(card.event_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Event Skills</div>${card.event_skills.map(s=>`<div class="skill">${escapeHtml(s)}</div>`).join('')}</div>`;

  freeSlot.dataset.cardId = card.char_id;
  freeSlot.dataset.supportId = card.support_id; // <--- save unique identifier
  freeSlot.classList.add('has-card');
  freeSlot.innerHTML = `<div class="type-icon"><img src="https://gametora.com/images/umamusume/icons/utx_ico_obtain_${typeMap[card.type]||"xx"}.png" alt="${escapeHtml(card.type)}"></div><img src="https://gametora.com/images/umamusume/supports/support_card_s_${card.support_id}.png" alt="${escapeHtml(card.char_name)}"><div class="name">${escapeHtml(card.char_name)}</div><div class="skills">${skillsHTML}</div>`;

  function slotClickHandler(){ removeFromSlot(freeSlot, card); }
  freeSlot.addEventListener('click', slotClickHandler);
  slotListeners.set(freeSlot, slotClickHandler);

  selectedCardIds.add(card.char_id);
  if(save) saveSlotsToLocalStorage();
  renderSections();
}


function removeFromSlot(slotEl, card){
  if(slotListeners.has(slotEl)){
    slotEl.removeEventListener('click', slotListeners.get(slotEl));
    slotListeners.delete(slotEl);
  }
  slotEl.classList.remove('has-card');
  delete slotEl.dataset.cardId;
  slotEl.innerHTML='<div class="placeholder">Empty</div>';
  selectedCardIds.delete(Number(card.char_id));
  saveSlotsToLocalStorage();
  renderSections();
}

/* ------------- Clear buttons ------------- */
clearAllBtn.addEventListener('click', ()=>{
  selectedCardIds.clear();
  slots.forEach(slot=>{
    if(slotListeners.has(slot)){
      slot.removeEventListener('click', slotListeners.get(slot));
      slotListeners.delete(slot);
    }
    slot.classList.remove('has-card');
    delete slot.dataset.cardId;
    slot.innerHTML='<div class="placeholder">Empty</div>';
  });
  localStorage.removeItem(SLOT_KEY);
  renderSections();
});

clearFiltersBtn.addEventListener('click', ()=>{
  FILTER_KEYS.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value='';
    localStorage.removeItem('filter_'+id);
  });
  renderSections();
});

/* ------------- Filter persistence ------------- */
function setupFilterPersistence(){
  FILTER_KEYS.forEach(id=>{
    const sel=document.getElementById(id); if(!sel)return;
    const saved=localStorage.getItem('filter_'+id); if(saved) sel.value=saved;
    sel.addEventListener('change', ()=>{
      localStorage.setItem('filter_'+id, sel.value);
      sectionPages.clear();
      renderSections();
    });
  });
}

/* ------------- FILTER BUILDING & MATCHING ------------- */
function buildFilterTerms(filters){
  const terms=[];
  if(filters.racecourse) terms.push(`${filters.racecourse} Racecourse`);
  if(filters.direction) terms.push(filters.direction==='Clockwise'?'Right-Handed':'Left-Handed');
  if(filters.track) terms.push(filters.track==='Firm'?'Firm Conditions':'Wet Conditions');
  if(filters.season) terms.push(`${filters.season} Runner`);
  if(filters.weather) terms.push(`${capitalize(filters.weather)} Days`);
  if(filters.strategy){
    const s=filters.strategy;
    terms.push(`${s} Corners`,`${s} Straightaways`,`${s} Savvy`);
  }
  if(filters.length){
    const dist=parseInt(filters.length);
    const label=getLengthCategory(dist);
    terms.push(`${label} Corners`,`${label} Straightaways`,isStandardDistance(dist)?'Standard Distance':'Non-Standard Distance');
  }
  return terms;
}
function filterCardsWithRules(cards,filters){
  const terms=buildFilterTerms(filters).map(normalizeSkill);
  const strictDistanceKeys=['standard distance','non-standard distance'];
  const strictTerms=terms.filter(t=>strictDistanceKeys.includes(t));
  const looseTerms=terms.filter(t=>!strictDistanceKeys.includes(t));
  return cards.filter(card=>{
    const skills=[...card.hint_skills,...card.event_skills].map(normalizeSkill);
    return strictTerms.every(t=>skills.includes(t)) && looseTerms.every(term=>skills.some(s=>s.includes(term)));
  });
}

/* ------------- Rendering sections & pagination ------------- */
function renderSections(){
  cardSections.innerHTML='';
  const filters={ racecourse: document.getElementById('racecourse').value||'', length: document.getElementById('length').value||'', direction: document.getElementById('direction').value||'', track: document.getElementById('track').value||'', season: document.getElementById('season').value||'', weather: document.getElementById('weather').value||'', strategy: document.getElementById('strategy').value||'' };
  const anyActive=Object.values(filters).some(v=>v);

  if(!anyActive){
    const section = document.createElement('div');
    section.className = 'card-section';
    const msg = document.createElement('div');
    msg.style.opacity = '0.7';
    msg.style.padding = '12px';
    msg.textContent = 'Pick a label on the left to show matching cards.';
    section.appendChild(msg);
    cardSections.appendChild(section);
    return;
  }

  const filterOrder=['racecourse','length','direction','track','season','weather','strategy'];
  filterOrder.forEach(catId=>{
    if(!filters[catId]) return;

    // handle length separately
    if(catId==='length'){
      const dist=parseInt(filters.length);
      const label=getLengthCategory(dist);
      const distanceType=isStandardDistance(dist)?'Standard Distance':'Non-Standard Distance';
      [{title:`${label} Corners`,terms:[`${label} Corners`]},{title:`${label} Straightaways`,terms:[`${label} Straightaways`]},{title:distanceType,terms:[distanceType]}].forEach((row,idx)=>renderFilterRow(catId,row.title,row.terms,idx));
    }else{
      let rowTerms=[];
      switch(catId){
        case 'racecourse': rowTerms.push(`${filters.racecourse} Racecourse`); break;
        case 'direction': rowTerms.push(filters.direction==='Clockwise'?'Right-Handed':'Left-Handed'); break;
        case 'track': rowTerms.push(filters.track==='Firm'?'Firm Conditions':'Wet Conditions'); break;
        case 'season': rowTerms.push(`${filters.season} Runner`); break;
        case 'weather': rowTerms.push(`${capitalize(filters.weather)} Days`); break;
        case 'strategy': rowTerms.push(`${filters.strategy} Corners`,`${filters.strategy} Straightaways`,`${filters.strategy} Savvy`); break;
      }
      renderFilterRow(catId,`${capitalize(catId)}: ${filters[catId]}`,rowTerms,0);
    }
  });

  function renderFilterRow(catId,headerText,termList,rowIndex){
    const section = document.createElement('div');
    section.className = 'card-section';

    const header = document.createElement('h2');
    header.textContent = headerText;
    section.appendChild(header);

    // create wrapper
    const wrapper = document.createElement('div');
    wrapper.className = 'card-grid-wrapper'; // new class
    wrapper.style.position = 'relative'; // ensure absolute positioning works

    const grid = document.createElement('div');
    grid.className = 'cards';
    wrapper.appendChild(grid);

    // pagination controls
    const controls = document.createElement('div');
    controls.className = 'page-controls';
    const leftBtn = document.createElement('button'); leftBtn.textContent = 'â—€';
    const rightBtn = document.createElement('button'); rightBtn.textContent = 'â–¶';
    [leftBtn, rightBtn].forEach(b => {
      b.style.border = 'none';
      b.style.borderRadius = '6px';
      b.style.background = '#444';
      b.style.color = '#fff';
      b.style.padding = '4px 8px';
      b.style.opacity = '0.4';
      b.style.pointerEvents = 'none';
    });
    controls.appendChild(leftBtn);
    controls.appendChild(rightBtn);

    // append controls to wrapper instead of section
    wrapper.appendChild(controls);

    // finally append wrapper to section
    section.appendChild(wrapper);

    // normalize filter terms
    const termsNormalized = termList.map(normalizeSkill);
    const strictDistanceKeys = ['standard distance','non-standard distance'];
    const strictTerms = termsNormalized.filter(t => strictDistanceKeys.includes(t));
    const looseTerms = termsNormalized.filter(t => !strictDistanceKeys.includes(t));

    // get matching cards
    const matches = cardsData.filter(card => {
      const skills = [...card.hint_skills, ...card.event_skills].map(normalizeSkill);
      return strictTerms.every(t => skills.includes(t)) && looseTerms.every(term => skills.some(s => s.includes(term)));
    });

    if(matches.length === 0){
      const noMsg = document.createElement('div');
      noMsg.style.opacity = '0.6';
      noMsg.textContent = '(No matching cards)';
      grid.appendChild(noMsg);
      cardSections.appendChild(section);
      return;
    }

    // current page
    const pageKey = `${catId}-${rowIndex}`;
    const currentPage = sectionPages.get(pageKey) || 0;
    sectionPages.set(pageKey, currentPage);


    const CARDS_PER_PAGE = 6;

    function renderPage(page, matches, grid, leftBtn, rightBtn, pageKey){
      grid.innerHTML = '';
      const startIdx = page * CARDS_PER_PAGE;
      const endIdx = startIdx + CARDS_PER_PAGE;
      const pageCards = matches.slice(startIdx, endIdx);
      pageCards.forEach(card => grid.appendChild(createCardElement(card)));

      const totalPages = Math.ceil(matches.length / CARDS_PER_PAGE);

      leftBtn.style.display = totalPages > 1 ? 'inline-block' : 'none';
      rightBtn.style.display = totalPages > 1 ? 'inline-block' : 'none';
      leftBtn.style.opacity = page > 0 ? '1' : '0.4';
      leftBtn.style.pointerEvents = page > 0 ? 'auto' : 'none';
      rightBtn.style.opacity = page < totalPages - 1 ? '1' : '0.4';
      rightBtn.style.pointerEvents = page < totalPages - 1 ? 'auto' : 'none';

      leftBtn.onclick = ()=>{ renderPage(page-1, matches, grid, leftBtn, rightBtn, pageKey); sectionPages.set(pageKey,page-1); };
      rightBtn.onclick = ()=>{ renderPage(page+1, matches, grid, leftBtn, rightBtn, pageKey); sectionPages.set(pageKey,page+1); };
    }

    renderPage(currentPage, matches, grid, leftBtn, rightBtn, pageKey);
    cardSections.appendChild(section);
  }
}

// Auto-update whenever a filter dropdown changes
['racecourse','length','direction','track','season','weather','strategy']
  .forEach(id => {
    document.getElementById(id).addEventListener('change', renderSections);
  });

// Re-run filters with remembered dropdowns on reload
document.addEventListener('DOMContentLoaded', () => {
  renderSections();
});

// Recalculate pagination on resize
window.addEventListener('resize', renderSections);

</script>

</body>
</html>
