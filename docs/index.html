<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Uma Builder — Card Picker</title>
<style>
:root {
  --card-w: 120px;  /* Balanced size */
  --gap: 8px;       /* Reduced gap */
}

/* Remove vertical scrollbar for entire page */
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  overflow: hidden; /* Prevent body scrollbar */
}

body {
  font-family: Arial, Helvetica, sans-serif;
  background: #fff;
  color: #111;
}

/* ---------- HEADER STYLES ---------- */
.header {
  height: 70px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.header-left {
  display: flex;
  align-items: center;
}

.header-logo {
  height: 40px;
  width: auto;
}

.header-title {
  margin-left: 12px;
  font-size: 18px;
  font-weight: bold;
  color: #333;
}

.header-nav {
  display: none; /* Hide nav links for now */
}

/* ---------- CONTAINER & SIDEBARS ---------- */
/* Adjust container to account for header */
.container {
  display: flex;
  width: 100%;
  height: calc(100vh - 70px);
  overflow: hidden; /* Ensure no scrollbar in container */
}

.sidebar {
  flex-shrink: 0;
  width: 200px;
  padding: 16px 12px; /* Consistent padding */
  box-sizing: border-box;
  background: #f9f9f9;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px; /* Consistent gap between items */
}

/* Hide sidebar scrollbars */
.sidebar::-webkit-scrollbar {
  display: none;
}
.sidebar {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

/* Right sidebar for slots */
.right-sidebar {
  flex-shrink: 0;
  padding: 16px 12px; /* Consistent padding with left sidebar */
  box-sizing: border-box;
  background: #f5f5f5;
  overflow-y: auto;
  border-left: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px; /* Consistent gap */
}

/* Hide right sidebar scrollbars */
.right-sidebar::-webkit-scrollbar {
  display: none;
}
.right-sidebar {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

/* Right sidebar specific styles */
.right-sidebar .slots-header {
  margin-top: 0; /* Remove extra top margin since we have consistent padding */
  margin-bottom: 0;
}

/* ---------- MAIN CONTENT (BALANCED SIZING) ---------- */

/* Hide scrollbars but keep scrolling functionality */
.main-content {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  overflow-y: auto; /* Keep scrolling enabled */
  padding: 20px;
  box-sizing: border-box;
}

/* Hide scrollbar for Webkit browsers (Chrome, Safari, Edge) */
.main-content::-webkit-scrollbar {
  display: none;
}

/* Hide scrollbar for Firefox */
.main-content {
  scrollbar-width: none;
}

/* Hide scrollbar for IE/Edge */
.main-content {
  -ms-overflow-style: none;
}

/* Wrapper to center cards */
.content-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  width: calc(var(--card-w) * 6 + var(--gap) * 5);
  margin: 0 auto;
}

/* ---------- SIDEBAR IMPROVEMENTS ---------- */
.sidebar .filter-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 0; /* Remove bottom margin since we use gap */
}

.sidebar .filter-group label {
  margin-bottom: 4px;
  font-weight: 600;
  font-size: 13px;
}

.sidebar select, .sidebar .skill-search {
  width: 100%;
  max-width: 180px;
  padding: 6px 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

/* Clear Filters Button - Top of sidebar */
#clearFiltersBtn {
  width: 100%;
  max-width: 180px;
  margin-bottom: 0; /* Remove bottom margin since we use gap */
}

/* Clear All Button - Right sidebar */
.slots-header .clear-all {
  width: calc(var(--card-w) * 2 + var(--gap) * 1); /* Same width as two slots */
  margin-bottom: 0; /* Remove bottom margin since we use gap */
}

/* Skill Search Group */
#skillSearchGroup {
  display: flex;
  flex-direction: column;
  gap: 8px;
  position: relative;
}

#skillSearchGroup label {
  margin-bottom: 4px;
  font-weight: 600;
  font-size: 13px;
}

/* Thin divider between strategy and skill search */
.skill-search-divider {
  height: 1px;
  background: #ddd;
  margin: 8px 0;
  width: 100%;
}

/* Skill search header with Add button */
.skill-search-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.add-search-btn {
  padding: 4px 8px;
  font-size: 11px;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #f5f5f5;
  color: #333;
}

.add-search-btn:hover {
  background: #e5e5e5;
}

/* Individual search input container */
.search-input-container {
  display: flex;
  align-items: center;
  gap: 4px;
  width: 100%;
}

.search-input-container input {
  flex: 1;
  padding: 6px 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

.remove-search-btn {
  width: 24px;
  height: 24px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #f5f5f5;
  color: #666;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: bold;
  flex-shrink: 0;
}

.remove-search-btn:hover {
  background: #e5e5e5;
  color: #333;
}

/* ---------- SLOTS STYLING ---------- */
.slots {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--gap);
  width: calc(var(--card-w) * 2 + var(--gap) * 1);
  margin: 0 auto;
}

.slot {
  border: 1px solid #ddd;
  padding: 8px;
  box-sizing: border-box;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  width: var(--card-w);
  min-height: var(--card-w);
  position: relative;
  transition: min-height 0.3s ease;
}

.slot:not(.has-card) {
  border: 2px dashed #ccc;
  background: #fafafa;
  aspect-ratio: 1;
  min-height: var(--card-w);
  height: var(--card-w);
}

.slot.has-card {
  min-height: calc(var(--card-w) * 2.2);
  aspect-ratio: auto;
  height: auto;
  /* Allow card to grow naturally with skills */
  max-height: none;
}

.slot .placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #ccc;
  font-size: 11px;
}

/* ---------- CARDS STYLING ---------- */
.cards {
  display: grid;
  grid-template-columns: repeat(6, var(--card-w));
  gap: var(--gap);
  width: calc(var(--card-w) * 6 + var(--gap) * 5);
}

/* Card styles for both main content and slots */
.card, .slot.has-card {
  border: 1px solid #ddd;
  padding: 6px;
  box-sizing: border-box;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  width: var(--card-w);
  min-height: 180px;
  position: relative;
}

.card .name, .slot.has-card .name {
  margin: 6px 0 4px 0;
  font-weight: 700;
  text-align: center;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.card img, .slot.has-card img {
  max-width: calc(var(--card-w) * 0.8); /* 80% of card width */
  max-height: calc(var(--card-w) * 0.8); /* 80% of card height */
  object-fit: contain;
}

.card .skills, .slot.has-card .skills,
.card .skills-group, .slot.has-card .skills-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
  width: 100%;
  align-items: center;
}

.card .skill, .slot.has-card .skill {
  width: 100%;
  background: #eef2ff;
  border-radius: 4px;
  padding: 2px 4px;
  font-size: 12px;
  word-break: break-word;
  white-space: normal;
  text-align: center;
}

/* TYPE ICON */
.card .type-icon, .slot.has-card .type-icon {
  position: absolute;
  top: 0px;
  right: 0px;
  width: 32px;
  height: 32px;
  border: 1px solid #ccc;
  background: #fff;
  border-radius: 3px;
  overflow: hidden;
  text-align: center;
  font-size: 8px;
  line-height: 14px;
  font-weight: bold;
}

.card .type-icon img, .slot.has-card .type-icon img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

/* ---------- SKILLS & HIGHLIGHTING ---------- */
.skill.search-highlighted {
  background: #ff4444 !important;
  color: white !important;
}

/* ---------- SKILLS HEADER STYLES ---------- */
.skills-header {
  font-size: 9px;
  font-weight: bold;
  margin-bottom: 3px;
  text-align: center;
  background: #000000;
  color: #ffffff;
  padding: 3px 4px;
  border-radius: 0;
  width: 100%;
}

/* ---------- PAGINATION CONTROLS ---------- */
.card-section {
  position: relative;
  width: 100%;
}

.card-section-header {
  position: relative;
  display: block;
  margin-top: 0px;
  margin-bottom: 10px;
  width: 100%;
}

.card-section-header h2 {
  margin: 0;
}

.page-controls {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  gap: 4px;
}

.page-controls button {
  border: 1px solid #ddd;
  background: #fff;
  color: #111;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  font-weight: bold;
  cursor: pointer;
  min-width: 32px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.page-controls button:hover:not(:disabled) {
  background: #f5f5f5;
}

.page-controls button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Hide duplicates */
.card.disabled {
  opacity: 0.45;
}

/* CLEAR BUTTON */
.clear-all {
  padding: 8px 12px; /* Slightly more padding for better touch targets */
  font-size: 12px;
  cursor: pointer;
  border: none;
  border-radius: 6px;
  background: #444;
  color: #fff;
  transition: background-color 0.2s;
}

.clear-all:hover {
  background: #333;
}

/* CARD SECTIONS */
.card-sections {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  gap: 10px;
}
</style>
</head>

<body>
<!-- Header -->
<div class="header">
  <div class="header-left">
    <img src="your-logo.png" alt="Logo" class="header-logo">
    <div class="header-title">Uma Builder</div>
  </div>
  <div class="header-nav">
    <!-- Navigation links are hidden -->
  </div>
</div>

  <div class="container">
<!-- Left Sidebar (Filters) -->
<div class="sidebar">
  <!-- Clear Filters Button at top -->
  <button id="clearFiltersBtn" class="clear-all clear-filters-top">Clear Filters</button>

  <div class="filter-group">
    <label for="presets">Presets</label>
    <select id="presets">
      <option value="">-- Select --</option>
    </select>
  </div>

      <div class="filter-group">
        <label for="racecourse">Racecourse</label>
        <select id="racecourse">
          <option value="">-- Select --</option>
          <option value="Sapporo">Sapporo</option>
          <option value="Hakodate">Hakodate</option>
          <option value="Niigata">Niigata</option>
          <option value="Fukushima">Fukushima</option>
          <option value="Nakayama">Nakayama</option>
          <option value="Tokyo">Tokyo</option>
          <option value="Chukyo">Chukyo</option>
          <option value="Kyoto">Kyoto</option>
          <option value="Hanshin">Hanshin</option>
          <option value="Kokura">Kokura</option>
          <option value="Oi">Oi</option>
          <option value="Kawasaki">Kawasaki</option>
          <option value="Funabashi">Funabashi</option>
          <option value="Morioka">Morioka</option>
          <option value="Longchamp">Longchamp</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="length">Length</label>
        <select id="length">
          <option value="">-- Select --</option>
          <option value="1000">1000m</option>
          <option value="1150">1150m</option>
          <option value="1200">1200m</option>
          <option value="1300">1300m</option>
          <option value="1400">1400m</option>
          <option value="1500">1500m</option>
          <option value="1600">1600m</option>
          <option value="1700">1700m</option>
          <option value="1800">1800m</option>
          <option value="1900">1900m</option>
          <option value="2000">2000m</option>
          <option value="2100">2100m</option>
          <option value="2200">2200m</option>
          <option value="2300">2300m</option>
          <option value="2400">2400m</option>
          <option value="2500">2500m</option>
          <option value="2600">2600m</option>
          <option value="3000">3000m</option>
          <option value="3200">3200m</option>
          <option value="3400">3400m</option>
          <option value="3600">3600m</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="direction">Direction</label>
        <select id="direction">
          <option value="">-- Select --</option>
          <option value="Clockwise">Clockwise</option>
          <option value="Counterclockwise">Counterclockwise</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="track">Track Conditions</label>
        <select id="track">
          <option value="">-- Select --</option>
          <option value="Firm">Firm</option>
          <option value="Good">Good</option>
          <option value="Soft">Soft</option>
          <option value="Heavy">Heavy</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="season">Season</label>
        <select id="season">
          <option value="">-- Select --</option>
          <option value="Spring">Spring</option>
          <option value="Summer">Summer</option>
          <option value="Fall">Fall</option>
          <option value="Winter">Winter</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="weather">Weather</label>
        <select id="weather">
          <option value="">-- Select --</option>
          <option value="Sunny">Sunny</option>
          <option value="Cloudy">Cloudy</option>
          <option value="Rainy">Rainy</option>
          <option value="Snowy">Snowy</option>
        </select>
      </div>

        <div class="filter-group">
          <label for="strategy">Strategy</label>
          <select id="strategy">
            <option value="">-- Select --</option>
            <option value="Front Runner">Front Runner</option>
            <option value="Pace Chaser">Pace Chaser</option>
            <option value="Late Surger">Late Surger</option>
            <option value="End Closer">End Closer</option>
          </select>
        </div>

        <!-- Thin divider -->
        <div class="skill-search-divider"></div>

        <!-- Skill Search Section -->
        <div id="skillSearchGroup">
          <div class="skill-search-header">
            <label for="skillSearch1">Skill Search</label>
            <button class="add-search-btn" id="addSearchBtn">Add</button>
          </div>
          
          <!-- Default search box -->
          <div class="search-input-container">
            <input type="text" id="skillSearch1" class="skill-search" placeholder="Search skill">
            <button class="remove-search-btn" data-search-id="skillSearch1">×</button>
          </div>
          
          <!-- Additional search boxes will be added here dynamically -->
        </div>
      </div>
</body>

<script>
/* ------------- CONFIG ------------- */
const JSON_FILE = "transformed_supports.json";
const HIDE = { char_id: false, url_name: true };

/* ------------- STATE ------------- */
let cardsData = [];
const cardSections = document.getElementById('cardSections');
const slots = Array.from(document.querySelectorAll('.right-sidebar .slot'));
const clearAllBtn = document.getElementById('clearAllBtn');
const clearFiltersBtn = document.getElementById('clearFiltersBtn');
const selectedCardIds = new Set();
const sectionPages = new Map();
const slotListeners = new Map();
const SLOT_KEY = 'saved_slots';
const FILTER_KEYS = ['racecourse','length','direction','track','season','weather','strategy'];

/* ------------- UTIL ------------- */
function normalizeSkill(s){ return String(s||'').replace(/[◎○]/g,'').trim().toLowerCase(); }
function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase(); }
function getLengthCategory(distance){ if(distance<=1400)return'Sprint'; if(distance<=1800)return'Mile'; if(distance<=2400)return'Medium'; return'Long'; }
function isStandardDistance(distance){ return distance%400===0; }
const typeMap = { "speed":"00","stamina":"01","power":"02","guts":"03","intelligence":"04","support":"05","group":"06" };
function escapeHtml(s){ return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ------------- Fetch JSON ------------- */
fetch(JSON_FILE)
  .then(r=>{ if(!r.ok) throw new Error('Failed to fetch JSON: '+r.status); return r.json(); })
  .then(data=>{
    cardsData = data.map(card=>({
      ...card,
      char_id: card.char_id,
      char_name: card.char_name,
      hint_skills: card.hint_skills || [],
      event_skills: card.event_skills || [],
      type: (card.type || '').toLowerCase()
    }));

    setupFilterPersistence();
    setupDynamicSkillSearch(); // Replace setupSkillSearchPersistence with this
    setupPresets();
    loadSlotsFromLocalStorage();
    renderSections();
  })
  .catch(err=>{
    console.error('Could not load JSON:', err);
    cardSections.innerHTML='<div style="opacity:0.7;padding:12px;">Error loading data. Check JSON file path and content in console.</div>';
  });

/* ------------- PRESETS ------------- */
const PRESETS_JSON_FILE = "champions_meeting.json";

function formatPresetDate(dateString) {
  const date = new Date(dateString);
  const month = date.toLocaleString('en-US', { month: 'short' });
  const year = date.getFullYear();
  return `${month} ${year}`;
}

function createPresetLabel(cup) {
  const date = formatPresetDate(cup.start_date);
  const distance = cup.distance === "Mile" ? "MILE" : cup.distance;
  const trackType = cup.aptitude === "Turf" ? "Turf" : "Dirt";
  const length = cup.length.replace(/\s*m/g, 'm');
  
  return `${date} — ${cup.title} — ${cup.racecourse} ${trackType} ${length} ${cup.track_conditions}`;
}

function setupPresets() {
  const presetsSelect = document.getElementById('presets');
  if (!presetsSelect) return;

  const savedPreset = localStorage.getItem('filter_presets');

  fetch(PRESETS_JSON_FILE)
    .then(response => {
      if (!response.ok) throw new Error('Failed to fetch presets JSON');
      return response.json();
    })
    .then(data => {
      presetsSelect.innerHTML = '<option value="">-- Select --</option>';
      
      data.cups.forEach(cup => {
        const option = document.createElement('option');
        option.value = cup.title;
        option.textContent = createPresetLabel(cup);
        option.dataset.cupData = JSON.stringify(cup);
        presetsSelect.appendChild(option);
      });
      
      if (savedPreset) presetsSelect.value = savedPreset;
      
      presetsSelect.addEventListener('change', function() {
        localStorage.setItem('filter_presets', this.value);
        
        if (this.value) {
          const selectedOption = this.options[this.selectedIndex];
          const cup = JSON.parse(selectedOption.dataset.cupData);
          applyPreset(cup);
        } else {
          sectionPages.clear();
          renderSections();
        }
      });
    })
    .catch(err => {
      console.error('Could not load presets:', err);
      const option = document.createElement('option');
      option.textContent = 'Error loading presets';
      option.disabled = true;
      presetsSelect.appendChild(option);
    });
}

function applyPreset(cup) {
  document.getElementById('racecourse').value = cup.racecourse;
  document.getElementById('length').value = cup.length.replace(' m', '');
  document.getElementById('direction').value = cup.direction;
  document.getElementById('track').value = cup.track_conditions;
  document.getElementById('season').value = cup.season;
  document.getElementById('weather').value = cup.weather;
  document.getElementById('strategy').value = '';
  
  FILTER_KEYS.forEach(id => {
    const el = document.getElementById(id);
    if (el && el.value) localStorage.setItem('filter_' + id, el.value);
  });
  
  sectionPages.clear();
  renderSections();
}

FILTER_KEYS.push('presets');

/* ------------- Card creation ------------- */
function createCardElement(card){
  const el = document.createElement('div');
  el.className = 'card';
  el.dataset.id = card.char_id;
  el.dataset.supportId = card.support_id;
  el.dataset.name = card.char_name;

  const imgSrc = `https://gametora.com/images/umamusume/supports/support_card_s_${card.support_id}.png`;
  const typeImg = `https://gametora.com/images/umamusume/icons/utx_ico_obtain_${typeMap[card.type]||"xx"}.png`;

  let skillsHTML = '';
  if(card.hint_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Support Hints</div>${card.hint_skills.map(s=>`<div class="skill">${escapeHtml(s.replace(/○\s*/g, ''))}</div>`).join('')}</div>`;
  if(card.event_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Event Skills</div>${card.event_skills.map(s=>`<div class="skill">${escapeHtml(s.replace(/○\s*/g, ''))}</div>`).join('')}</div>`;
  
  let nameHtml = `<div class="name">${escapeHtml(card.char_name)}</div>`;
  if(!HIDE.char_id) nameHtml += `<div style="font-size:9px;opacity:0.6;margin-bottom: 6px;">ID: ${card.char_id}</div>`;
  if(!HIDE.url_name && card.url_name) nameHtml += `<div style="font-size:9px;opacity:0.6;">${escapeHtml(card.url_name)}</div>`;

  el.innerHTML = `
    <div class="type-icon"><img src="${typeImg}" alt="${escapeHtml(card.type)}"></div>
    <img src="${imgSrc}" alt="${escapeHtml(card.char_name)}">
    ${nameHtml}
    <div class="skills">${skillsHTML}</div>
  `;

  el.addEventListener('click', ()=> {
    const slot = slots.find(s => Number(s.dataset.cardId) === card.char_id);
    if(slot) removeFromSlot(slot, card);
    else addToSlot(card);
  });

  if(selectedCardIds.has(card.char_id)){
    el.classList.add('disabled');
    const dupLabel = document.createElement('div');
    dupLabel.textContent = 'Duplicate Support';
    dupLabel.style.position = 'absolute';
    dupLabel.style.top = '0';
    dupLabel.style.left = '0';
    dupLabel.style.width = '100%';
    dupLabel.style.background = 'red';
    dupLabel.style.color = 'white';
    dupLabel.style.fontSize = '9px';
    dupLabel.style.fontWeight = 'bold';
    dupLabel.style.textAlign = 'center';
    dupLabel.style.padding = '2px 0';
    dupLabel.style.borderTopLeftRadius = '4px';
    dupLabel.style.borderTopRightRadius = '4px';
    el.appendChild(dupLabel);
  }

  return el;
}

/* ------------- Slot handling & persistence ------------- */
function saveSlotsToLocalStorage() {
  const slotData = slots.map(s => s.dataset.supportId || null);
  localStorage.setItem(SLOT_KEY, JSON.stringify(slotData));
}

function loadSlotsFromLocalStorage() {
  const saved = localStorage.getItem(SLOT_KEY);
  if (!saved) return;
  const slotData = JSON.parse(saved);

  slotData.forEach((supportId, index) => {
    if (supportId) {
      const card = cardsData.find(c => String(c.support_id) === String(supportId));
      if (card) addToSlot(card, slots[index], false);
    }
  });
}

function addToSlot(card, targetSlot = null, save = true){
  const freeSlot = targetSlot || slots.find(s => !s.dataset.cardId);
  if(!freeSlot) return;

  if(slotListeners.has(freeSlot)){
    freeSlot.removeEventListener('click', slotListeners.get(freeSlot));
    slotListeners.delete(freeSlot);
  }

let skillsHTML = '';
if(card.hint_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Support Hints</div>${card.hint_skills.map(s=>`<div class="skill">${escapeHtml(s.replace(/○\s*/g, ''))}</div>`).join('')}</div>`;
if(card.event_skills.length) skillsHTML += `<div class="skills-group"><div class="skills-header">Event Skills</div>${card.event_skills.map(s=>`<div class="skill">${escapeHtml(s.replace(/○\s*/g, ''))}</div>`).join('')}</div>`;
  freeSlot.dataset.cardId = card.char_id;
  freeSlot.dataset.supportId = card.support_id;
  freeSlot.classList.add('has-card');
  
  // Use compact styling for slots
  freeSlot.innerHTML = `
    <div class="type-icon"><img src="https://gametora.com/images/umamusume/icons/utx_ico_obtain_${typeMap[card.type]||"xx"}.png" alt="${escapeHtml(card.type)}"></div>
    <img src="https://gametora.com/images/umamusume/supports/support_card_s_${card.support_id}.png" alt="${escapeHtml(card.char_name)}">
    <div class="name">${escapeHtml(card.char_name)}</div>
    <div class="skills">${skillsHTML}</div>
  `;

  function slotClickHandler(){ removeFromSlot(freeSlot, card); }
  freeSlot.addEventListener('click', slotClickHandler);
  slotListeners.set(freeSlot, slotClickHandler);

  selectedCardIds.add(card.char_id);
  if(save) saveSlotsToLocalStorage();
  renderSections();
}

function removeFromSlot(slotEl, card){
  if(slotListeners.has(slotEl)){
    slotEl.removeEventListener('click', slotListeners.get(slotEl));
    slotListeners.delete(slotEl);
  }
  slotEl.classList.remove('has-card');
  delete slotEl.dataset.cardId;
  slotEl.innerHTML='<div class="placeholder">Empty</div>';
  selectedCardIds.delete(Number(card.char_id));
  saveSlotsToLocalStorage();
  renderSections();
}

/* ------------- Clear buttons ------------- */
clearAllBtn.addEventListener('click', ()=>{
  selectedCardIds.clear();
  slots.forEach(slot=>{
    if(slotListeners.has(slot)){
      slot.removeEventListener('click', slotListeners.get(slot));
      slotListeners.delete(slot);
    }
    slot.classList.remove('has-card');
    delete slot.dataset.cardId;
    slot.innerHTML='<div class="placeholder">Empty</div>';
  });
  localStorage.removeItem(SLOT_KEY);
  renderSections();
});

clearFiltersBtn.addEventListener('click', () => {
  FILTER_KEYS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
    localStorage.removeItem('filter_' + id);
  });
  const presetsSelect = document.getElementById('presets');
  if (presetsSelect) presetsSelect.value = '';
  sectionPages.clear();
  renderSections();
});

/* ------------- Filter persistence ------------- */
function setupFilterPersistence(){
  FILTER_KEYS.forEach(id=>{
    const el=document.getElementById(id); if(!el)return;
    const saved=localStorage.getItem('filter_'+id); if(saved) el.value=saved;
    el.addEventListener('change', ()=>{
      localStorage.setItem('filter_'+id, el.value);
      sectionPages.clear();
      renderSections();
    });
  });
}

/* ------------- Skill Search persistence + rendering ------------- */
function setupSkillSearchPersistence(){
  SKILL_SEARCH_KEYS.forEach(id=>{
    const input = document.getElementById(id);
    if(!input) return;
    const saved = localStorage.getItem('filter_'+id);
    if(saved) input.value = saved;
    input.addEventListener('input', ()=>{
      localStorage.setItem('filter_'+id, input.value);
      sectionPages.clear();
      renderSections();
    });
  });
}

/* ------------- CONCISE HIGHLIGHTING LOGIC ------------- */
function highlightSkills() {
  document.querySelectorAll('.skill').forEach(skill => {
    skill.classList.remove('highlighted', 'search-highlighted');
    skill.style.background = '#eef2ff';
    skill.style.color = '#000';
  });

  const filters = {
    racecourse: document.getElementById('racecourse').value || '',
    length: document.getElementById('length').value || '',
    direction: document.getElementById('direction').value || '',
    track: document.getElementById('track').value || '',
    season: document.getElementById('season').value || '',
    weather: document.getElementById('weather').value || '',
    strategy: document.getElementById('strategy').value || ''
  };

  const searchTerms = SKILL_SEARCH_KEYS
    .map(id => document.getElementById(id)?.value.trim().toLowerCase())
    .filter(Boolean);

  const colorMap = {
    racecourse: '#ff7792', length: '#ffae77', direction: '#ffff77',
    track: '#77ff92', season: '#77c9ff', weather: '#c977ff', strategy: '#ff77e4'
  };

  const dropdownTerms = [];
  if (filters.racecourse) dropdownTerms.push({ term: `${filters.racecourse} Racecourse`, color: colorMap.racecourse });
  if (filters.direction) {
    const dirTerm = filters.direction === 'Clockwise' ? 'Right-Handed' : 'Left-Handed';
    dropdownTerms.push({ term: dirTerm, color: colorMap.direction });
  }
  if (filters.track) {
    const trackTerm = filters.track === 'Firm' ? 'Firm Conditions' : 'Wet Conditions';
    dropdownTerms.push({ term: trackTerm, color: colorMap.track });
  }
  if (filters.season) dropdownTerms.push({ term: `${filters.season} Runner`, color: colorMap.season });
  if (filters.weather) dropdownTerms.push({ term: `${capitalize(filters.weather)} Days`, color: colorMap.weather });
  if (filters.strategy) {
    const s = filters.strategy;
    dropdownTerms.push(
      { term: `${s} Corners`, color: colorMap.strategy },
      { term: `${s} Straightaways`, color: colorMap.strategy },
      { term: `${s} Savvy`, color: colorMap.strategy }
    );
  }
  if (filters.length) {
    const dist = parseInt(filters.length, 10);
    const label = getLengthCategory(dist);
    const distType = isStandardDistance(dist) ? 'Standard Distance' : 'Non-Standard Distance';
    dropdownTerms.push(
      { term: `${label} Corners`, color: colorMap.length },
      { term: `${label} Straightaways`, color: colorMap.length },
      { term: distType, color: colorMap.length }
    );
  }

  document.querySelectorAll('.skill').forEach(skill => {
    const skillText = normalizeSkill(skill.textContent || '');
    
    if (searchTerms.some(term => skillText.includes(term))) {
      skill.classList.add('search-highlighted');
      return;
    }
    
    for (const { term, color } of dropdownTerms) {
      if (skillText === normalizeSkill(term)) {
        skill.style.background = color;
        skill.style.color = '#000';
        skill.classList.add('highlighted');
        break;
      }
    }
  });
}

/* ------------- FILTER BUILDING & MATCHING ------------- */
function buildFilterTerms(filters){
  const terms=[];
  if(filters.racecourse) terms.push(`${filters.racecourse} Racecourse`);
  if(filters.direction) terms.push(filters.direction==='Clockwise'?'Right-Handed':'Left-Handed');
  if(filters.track) terms.push(filters.track==='Firm'?'Firm Conditions':'Wet Conditions');
  if(filters.season) terms.push(`${filters.season} Runner`);
  if(filters.weather) terms.push(`${capitalize(filters.weather)} Days`);
  if(filters.strategy){
    const s=filters.strategy;
    terms.push(`${s} Corners`,`${s} Straightaways`,`${s} Savvy`);
  }
  if(filters.length){
    const dist=parseInt(filters.length);
    const label=getLengthCategory(dist);
    terms.push(`${label} Corners`,`${label} Straightaways`,isStandardDistance(dist)?'Standard Distance':'Non-Standard Distance');
  }
  return terms;
}

function filterCardsWithRules(cards,filters){
  const terms=buildFilterTerms(filters).map(normalizeSkill);
  const strictDistanceKeys=['standard distance','non-standard distance'];
  const strictTerms=terms.filter(t=>strictDistanceKeys.includes(t));
  const looseTerms=terms.filter(t=>!strictDistanceKeys.includes(t));
  return cards.filter(card=>{
    const skills=[...card.hint_skills,...card.event_skills].map(normalizeSkill);
    return strictTerms.every(t=>skills.includes(t)) && looseTerms.every(term=>skills.some(s=>s.includes(term)));
  });
}

/* ------------- Rendering sections & pagination ------------- */
function renderSections() {
  cardSections.innerHTML='';

  const filters = {
    racecourse: document.getElementById('racecourse').value || '',
    length: document.getElementById('length').value || '',
    direction: document.getElementById('direction').value || '',
    track: document.getElementById('track').value || '',
    season: document.getElementById('season').value || '',
    weather: document.getElementById('weather').value || '',
    strategy: document.getElementById('strategy').value || ''
  };

  const anyDropdownActive = Object.values(filters).some(v => v);
  const anySkillActive = SKILL_SEARCH_KEYS.some(key => document.getElementById(key)?.value.trim());

if(!anyDropdownActive && !anySkillActive) {
  const section = document.createElement('div');
  section.className = 'card-section';
  section.style.display = 'flex';
  section.style.flexDirection = 'column';
  section.style.alignItems = 'center';
  section.style.justifyContent = 'center';
  const msg = document.createElement('div');
  msg.style.opacity = '0.7';
  msg.style.padding = '0px';
  msg.style.marginTop = '20px';
  msg.style.marginBottom = '10px';
  msg.textContent = 'Pick a label on the left or type a skill to show matching cards.';
  section.appendChild(msg);
  cardSections.appendChild(section);
  return;
}

  const filterOrder = ['racecourse','length','direction','track','season','weather','strategy'];
  filterOrder.forEach(catId => {
    if (!filters[catId]) return;

    if (catId === 'length') {
      const dist = parseInt(filters.length);
      const label = getLengthCategory(dist);
      const distanceType = isStandardDistance(dist) ? 'Standard Distance' : 'Non-Standard Distance';

      [
        { title: `${label} Corners`, terms: [`${label} Corners`] },
        { title: `${label} Straightaways`, terms: [`${label} Straightaways`] },
        { title: distanceType, terms: [distanceType] }
      ].forEach((row, idx) => renderFilterRow(catId, row.title, row.terms, idx));

    } else if (catId === 'strategy') {
      const strat = filters.strategy;
      const stratRows = [
        { title: `${strat} Corners`, term: `${strat} Corners` },
        { title: `${strat} Straightaways`, term: `${strat} Straightaways` },
        { title: `${strat} Savvy`, term: `${strat} Savvy` }
      ];
      stratRows.forEach((row, idx) => renderFilterRow(catId, row.title, [row.term], idx));

    } else {
      let rowTerms = [], headerText = '';
      switch (catId) {
        case 'racecourse': rowTerms.push(`${filters.racecourse} Racecourse`); headerText = `${filters.racecourse} Racecourse`; break;
        case 'direction': const dir = filters.direction === 'Clockwise' ? 'Right-Handed' : 'Left-Handed'; rowTerms.push(dir); headerText = dir; break;
        case 'track': const trackLabel = filters.track === 'Firm' ? 'Firm Conditions' : 'Wet Conditions'; rowTerms.push(trackLabel); headerText = trackLabel; break;
        case 'season': rowTerms.push(`${filters.season} Runner`); headerText = `${filters.season} Runner`; break;
        case 'weather': rowTerms.push(`${capitalize(filters.weather)} Days`); headerText = `${capitalize(filters.weather)} Days`; break;
      }
      renderFilterRow(catId, headerText, rowTerms, 0);
    }
  });

  SKILL_SEARCH_KEYS.forEach((key, i) => {
    const val = document.getElementById(key)?.value.trim();
    if (!val) return;

    const normalized = normalizeSkill(val);
    const matches = cardsData.filter(card => {
      const skills = [...card.hint_skills, ...card.event_skills].map(normalizeSkill);
      return skills.some(s => s.includes(normalized));
    });

    const header = `Skill Search ${i + 1}: "${val}"`;
    renderSkillSearchRow(key, header, matches, i);
  });

  highlightSkills();
}

function renderFilterRow(catId,headerText,termList,rowIndex){
  const section = document.createElement('div');
  section.className = 'card-section';

  const headerContainer = document.createElement('div');
  headerContainer.className = 'card-section-header';

  const header = document.createElement('h2');
  header.textContent = headerText;
  headerContainer.appendChild(header);

  const controls = document.createElement('div');
  controls.className = 'page-controls';
  const leftBtn = document.createElement('button'); 
  leftBtn.textContent = '◀';
  leftBtn.disabled = true;
  const rightBtn = document.createElement('button'); 
  rightBtn.textContent = '▶';
  rightBtn.disabled = true;
  controls.appendChild(leftBtn);
  controls.appendChild(rightBtn);

  headerContainer.appendChild(controls);
  section.appendChild(headerContainer);

  const wrapper = document.createElement('div');
  wrapper.className = 'card-grid-wrapper';
  const grid = document.createElement('div');
  grid.className = 'cards';
  wrapper.appendChild(grid);
  section.appendChild(wrapper);

  const termsNormalized = termList.map(normalizeSkill);
  const strictDistanceKeys = ['standard distance','non-standard distance'];
  const strictTerms = termsNormalized.filter(t => strictDistanceKeys.includes(t));
  const looseTerms = termsNormalized.filter(t => !strictDistanceKeys.includes(t));

  const matches = cardsData.filter(card => {
    const skills = [...card.hint_skills, ...card.event_skills].map(normalizeSkill);
    return strictTerms.every(t => skills.includes(t)) && looseTerms.every(term => skills.some(s => s.includes(term)));
  });

  if(matches.length === 0){
    const noMsg = document.createElement('div');
    noMsg.style.opacity = '0.6';
    noMsg.textContent = '(No matching cards)';
    grid.appendChild(noMsg);
    cardSections.appendChild(section);
    return;
  }

  const pageKey = `${catId}-${rowIndex}`;
  const currentPage = sectionPages.get(pageKey) || 0;
  sectionPages.set(pageKey, currentPage);

  const CARDS_PER_PAGE = 6;

  function renderPage(page, matches, grid, leftBtn, rightBtn, pageKey){
    grid.innerHTML = '';
    const startIdx = page * CARDS_PER_PAGE;
    const endIdx = startIdx + CARDS_PER_PAGE;
    const pageCards = matches.slice(startIdx, endIdx);
    pageCards.forEach(card => grid.appendChild(createCardElement(card)));

    const totalPages = Math.ceil(matches.length / CARDS_PER_PAGE);

    leftBtn.style.display = totalPages > 1 ? 'flex' : 'none';
    rightBtn.style.display = totalPages > 1 ? 'flex' : 'none';
    leftBtn.disabled = page === 0;
    rightBtn.disabled = page >= totalPages - 1;

    leftBtn.onclick = ()=>{ 
      renderPage(page-1, matches, grid, leftBtn, rightBtn, pageKey); 
      sectionPages.set(pageKey,page-1);
      highlightSkills();
    };
    rightBtn.onclick = ()=>{ 
      renderPage(page+1, matches, grid, leftBtn, rightBtn, pageKey); 
      sectionPages.set(pageKey,page+1);
      highlightSkills();
    };
    
    highlightSkills();
  }

  renderPage(currentPage, matches, grid, leftBtn, rightBtn, pageKey);
  cardSections.appendChild(section);
}

function renderSkillSearchRow(key, headerText, matches, rowIndex) {
  const section = document.createElement('div');
  section.className = 'card-section';

  const headerContainer = document.createElement('div');
  headerContainer.className = 'card-section-header';

  const header = document.createElement('h2');
  header.className = 'skill-search-header';
  header.textContent = headerText;
  headerContainer.appendChild(header);

  const controls = document.createElement('div');
  controls.className = 'page-controls';
  const leftBtn = document.createElement('button');
  const rightBtn = document.createElement('button');
  leftBtn.textContent = '◀';
  leftBtn.disabled = true;
  rightBtn.textContent = '▶';
  rightBtn.disabled = true;
  controls.appendChild(leftBtn);
  controls.appendChild(rightBtn);

  headerContainer.appendChild(controls);
  section.appendChild(headerContainer);

  const wrapper = document.createElement('div');
  wrapper.className = 'card-grid-wrapper';
  const grid = document.createElement('div');
  grid.className = 'cards';
  wrapper.appendChild(grid);
  section.appendChild(wrapper);

  cardSections.appendChild(section);

  if (matches.length === 0) {
    const noMsg = document.createElement('div');
    noMsg.style.opacity = '0.6';
    noMsg.textContent = '(No matching cards)';
    grid.appendChild(noMsg);
    return;
  }

  const pageKey = `${key}-${rowIndex}`;
  const currentPage = sectionPages.get(pageKey) || 0;
  sectionPages.set(pageKey, currentPage);

  const CARDS_PER_PAGE = 6;

  function renderPage(page) {
    grid.innerHTML = '';
    const startIdx = page * CARDS_PER_PAGE;
    const pageCards = matches.slice(startIdx, startIdx + CARDS_PER_PAGE);
    pageCards.forEach(card => grid.appendChild(createCardElement(card)));

    const totalPages = Math.ceil(matches.length / CARDS_PER_PAGE);
    leftBtn.style.display = totalPages > 1 ? 'flex' : 'none';
    rightBtn.style.display = totalPages > 1 ? 'flex' : 'none';
    leftBtn.disabled = page === 0;
    rightBtn.disabled = page >= totalPages - 1;
    
    highlightSkills();
  }

  renderPage(currentPage);

  leftBtn.addEventListener('click', () => {
    const newPage = sectionPages.get(pageKey) - 1;
    if (newPage >= 0) {
      sectionPages.set(pageKey, newPage);
      renderPage(newPage);
      highlightSkills();
    }
  });

  rightBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(matches.length / CARDS_PER_PAGE);
    const newPage = sectionPages.get(pageKey) + 1;
    if (newPage < totalPages) {
      sectionPages.set(pageKey, newPage);
      renderPage(newPage);
      highlightSkills();
    }
  });
}

/* ------------- DYNAMIC SKILL SEARCH ------------- */
let searchCounter = 1;
const maxSearches = 5;
const SKILL_SEARCH_KEYS = ['skillSearch1']; // Start with just one

function setupDynamicSkillSearch() {
  const addSearchBtn = document.getElementById('addSearchBtn');
  const skillSearchGroup = document.getElementById('skillSearchGroup');

  addSearchBtn.addEventListener('click', addSearchBox);

  // Set up event listener for the default search box
  setupSearchInput('skillSearch1');
}

function addSearchBox() {
  if (searchCounter >= maxSearches) return;

  searchCounter++;
  const searchId = `skillSearch${searchCounter}`;
  SKILL_SEARCH_KEYS.push(searchId);

  const searchContainer = document.createElement('div');
  searchContainer.className = 'search-input-container';
  searchContainer.innerHTML = `
    <input type="text" id="${searchId}" class="skill-search" placeholder="Search skill">
    <button class="remove-search-btn" data-search-id="${searchId}">×</button>
  `;

  const skillSearchGroup = document.getElementById('skillSearchGroup');
  skillSearchGroup.appendChild(searchContainer);

  setupSearchInput(searchId);
  setupRemoveButton(searchId);

  // Update localStorage with empty value for new search
  localStorage.setItem('filter_' + searchId, '');
}

function setupSearchInput(searchId) {
  const input = document.getElementById(searchId);
  if (!input) return;

  // Load saved value
  const saved = localStorage.getItem('filter_' + searchId);
  if (saved) input.value = saved;

  // Set up input event
  input.addEventListener('input', () => {
    localStorage.setItem('filter_' + searchId, input.value);
    sectionPages.clear();
    renderSections();
  });
}

function setupRemoveButton(searchId) {
  const removeBtn = document.querySelector(`.remove-search-btn[data-search-id="${searchId}"]`);
  if (!removeBtn) return;

  removeBtn.addEventListener('click', () => {
    removeSearchBox(searchId);
  });
}

function removeSearchBox(searchId) {
  // Don't remove the first search box
  if (searchId === 'skillSearch1') return;

  const searchContainer = document.querySelector(`.search-input-container input#${searchId}`)?.parentNode;
  if (!searchContainer) return;

  // Remove from DOM
  searchContainer.remove();

  // Remove from arrays and localStorage
  const index = SKILL_SEARCH_KEYS.indexOf(searchId);
  if (index > -1) {
    SKILL_SEARCH_KEYS.splice(index, 1);
  }
  localStorage.removeItem('filter_' + searchId);

  // Update search counter
  searchCounter = SKILL_SEARCH_KEYS.length;

  // Re-render sections
  sectionPages.clear();
  renderSections();
}

// Update the existing skill search persistence to handle dynamic inputs
function setupSkillSearchPersistence() {
  // This is now handled by setupDynamicSkillSearch and setupSearchInput
}

// Update the highlightSkills function to work with dynamic search boxes
// (it should already work since it uses SKILL_SEARCH_KEYS array)

// Auto-update whenever a filter dropdown changes
['racecourse','length','direction','track','season','weather','strategy']
  .forEach(id => {
    document.getElementById(id).addEventListener('change', renderSections);
  });

document.addEventListener('DOMContentLoaded', () => {
  renderSections();
});

window.addEventListener('resize', renderSections);
</script>
</body>
</html>